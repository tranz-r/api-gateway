worker_processes 1;
events { worker_connections 1024; }

http {
    lua_shared_dict jwt_cache 10m;
    lua_package_path "/etc/nginx/lua/?.lua;;";

    server {
        listen 80;
        server_name localhost;

        location /healthz {
            access_log off;
            return 200 "OK";
        }

        location ~ ^/(auth|public|quote)/ {
            proxy_pass http://localhost:3500/v1.0/invoke/public-service/method/$uri$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location ~ ^/api/([^/]+)/(.*) {
            set $service $1;
            set $path $2;

            access_by_lua_block {
                local verifier = require("jwt_verifier")
                local ok, err = verifier.validate()
                if not ok then
                    ngx.status = 401
                    ngx.say(err)
                    return ngx.exit(401)
                end
            }

            proxy_pass http://localhost:3500/v1.0/invoke/$service/method/$path$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header Authorization $http_authorization;
        }

        location / {
            return 404 "Route not found";
        }
    }
}