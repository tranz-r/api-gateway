server {
    listen 80;

    # ======================
    # ðŸ”’ AUTHENTICATION (Applies to all endpoints by default)
    # ======================
    access_by_lua_block {
        local path = ngx.var.request_uri
        
        # Skip auth for public endpoints
        if path:match("^/healthz") or path:match("^/docs") then
            return
        end
        
        # Validate JWT for all other routes
        local jwt = require("nginx-jwt-keycloak")
        local valid, claims = jwt.auth({
            discovery = "https://iam.labgrid.net/realms/tranzr/.well-known/openid-configuration",
            client_id = "api-gateway",
            realm = "tranzr",
            # ssl_verify = "yes"  # Disable for local Keycloak
        })
        if not valid then
            ngx.log(ngx.ERR, "JWT validation failed")
            return ngx.exit(401)
        end
        
        # Forward user info to backends
        ngx.req.set_header("X-User-ID", claims.sub)
    }

    # ======================
    # âœ… PUBLIC ENDPOINTS
    # ======================
    location = /healthz {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    location /docs {
        proxy_pass http://localhost:3500/v1.0/invoke/docs-service/method/;
    }

    # ======================
    # ðŸ”’ AUTHENTICATED ENDPOINTS
    # ======================
    location /api/orders {
        proxy_pass http://localhost:3500/v1.0/invoke/orders-service/method/;
    }

    location /api/users {
        proxy_pass http://localhost:3500/v1.0/invoke/users-service/method/;
    }

    location /api/products {
        proxy_pass http://localhost:3500/v1.0/invoke/products-service/method/;
    }
}